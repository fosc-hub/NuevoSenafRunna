"use client"

import type React from "react"
import {
  Grid,
  Typography,
  Paper,
  Box,
  Chip,
  Alert,
  Divider,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Card,
  CardContent,
  CardHeader,
  Avatar,
} from "@mui/material"
import {
  Warning as WarningIcon,
  Gavel as GavelIcon,
  CheckCircle as CheckCircleIcon,
  Person as PersonIcon,
  Schedule as ScheduleIcon,
} from "@mui/icons-material"
import type {
  DisplayTabProps,
  CondicionVulnerabilidadEmbedded,
  VulneracionEmbedded,
} from "../types/persona-completa.types"

// Helper to format date
const formatFecha = (fecha: string | null | undefined): string => {
  if (!fecha) return "No registrado"
  try {
    const date = new Date(fecha)
    return date.toLocaleDateString("es-AR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
    })
  } catch {
    return fecha || "No registrado"
  }
}

// Get color based on severity/urgency
const getSeverityColor = (nombre: string): "error" | "warning" | "info" | "default" => {
  const upper = nombre?.toUpperCase() || ""
  if (upper.includes("GRAVE") || upper.includes("INMEDIATA") || upper.includes("ALTA")) return "error"
  if (upper.includes("MODERADA") || upper.includes("URGENTE") || upper.includes("MEDIA")) return "warning"
  if (upper.includes("LEVE") || upper.includes("PROGRAMADA") || upper.includes("BAJA")) return "info"
  return "default"
}

interface CondicionCardProps {
  condicion: CondicionVulnerabilidadEmbedded
}

const CondicionCard: React.FC<CondicionCardProps> = ({ condicion }) => {
  const info = condicion.condicion_vulnerabilidad_info

  return (
    <ListItem
      sx={{
        border: "1px solid",
        borderColor: "divider",
        borderRadius: 1,
        mb: 1,
        bgcolor: "background.paper",
      }}
    >
      <ListItemIcon>
        <WarningIcon color="warning" />
      </ListItemIcon>
      <ListItemText
        primary={
          <Typography variant="subtitle2" sx={{ fontWeight: 500 }}>
            {info?.nombre || "Condición"}
          </Typography>
        }
        secondary={
          condicion.si_no ? (
            <Chip
              icon={<CheckCircleIcon fontSize="small" />}
              label="Aplica"
              size="small"
              color="success"
              variant="outlined"
              sx={{ mt: 0.5 }}
            />
          ) : null
        }
      />
    </ListItem>
  )
}

interface VulneracionCardProps {
  vulneracion: VulneracionEmbedded
}

const VulneracionCard: React.FC<VulneracionCardProps> = ({ vulneracion }) => {
  const motivoInfo = vulneracion.categoria_motivo_info
  const submotivoInfo = vulneracion.categoria_submotivo_info
  const gravedadInfo = vulneracion.gravedad_vulneracion_info
  const urgenciaInfo = vulneracion.urgencia_vulneracion_info
  const autorInfo = vulneracion.autor_dv_info

  return (
    <Card
      variant="outlined"
      sx={{
        mb: 2,
        borderLeft: 4,
        borderLeftColor: vulneracion.transcurre_actualidad ? "error.main" : "grey.400",
      }}
    >
      <CardHeader
        avatar={
          <Avatar sx={{ bgcolor: vulneracion.principal_demanda ? "error.main" : "grey.500" }}>
            <GavelIcon />
          </Avatar>
        }
        title={
          <Box sx={{ display: "flex", alignItems: "center", gap: 1, flexWrap: "wrap" }}>
            <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
              {motivoInfo?.nombre || "Vulneración"}
            </Typography>
            {vulneracion.principal_demanda && (
              <Chip label="Principal" size="small" color="error" />
            )}
            {vulneracion.transcurre_actualidad && (
              <Chip
                icon={<ScheduleIcon fontSize="small" />}
                label="En curso"
                size="small"
                color="error"
                variant="outlined"
              />
            )}
          </Box>
        }
        subheader={
          <Typography variant="body2" color="text.secondary">
            {submotivoInfo?.nombre || ""}
          </Typography>
        }
      />
      <CardContent sx={{ pt: 0 }}>
        <Grid container spacing={2}>
          {/* Gravedad y Urgencia */}
          <Grid item xs={12} md={6}>
            <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
              <Chip
                label={`Gravedad: ${gravedadInfo?.nombre || "N/A"}`}
                size="small"
                color={getSeverityColor(gravedadInfo?.nombre || "")}
                variant="outlined"
              />
              <Chip
                label={`Urgencia: ${urgenciaInfo?.nombre || "N/A"}`}
                size="small"
                color={getSeverityColor(urgenciaInfo?.nombre || "")}
                variant="outlined"
              />
            </Box>
          </Grid>

          {/* Autor DV */}
          {autorInfo && (
            <Grid item xs={12}>
              <Paper variant="outlined" sx={{ p: 1.5, bgcolor: "grey.50" }}>
                <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                  <PersonIcon color="action" fontSize="small" />
                  <Typography variant="caption" color="text.secondary">
                    Supuesto Autor:
                  </Typography>
                  <Typography variant="body2" sx={{ fontWeight: 500 }}>
                    {autorInfo.nombre} {autorInfo.apellido}
                    {autorInfo.dni && ` (DNI: ${autorInfo.dni})`}
                  </Typography>
                </Box>
              </Paper>
            </Grid>
          )}

          {/* Fecha */}
          <Grid item xs={12}>
            <Typography variant="caption" color="text.secondary">
              Registrada: {formatFecha(vulneracion.fecha_creacion)}
              {vulneracion.ultima_modificacion !== vulneracion.fecha_creacion && (
                <> | Modificada: {formatFecha(vulneracion.ultima_modificacion)}</>
              )}
            </Typography>
          </Grid>
        </Grid>
      </CardContent>
    </Card>
  )
}

const VulnerabilityDisplay: React.FC<DisplayTabProps> = ({ persona }) => {
  const condiciones = persona.condiciones_vulnerabilidad || []
  const vulneraciones = persona.vulneraciones || []

  const hasAnyData = condiciones.length > 0 || vulneraciones.length > 0

  if (!hasAnyData) {
    return (
      <Box>
        <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 2 }}>
          <WarningIcon color="primary" />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Vulnerabilidad
          </Typography>
        </Box>
        <Alert severity="success" icon={<CheckCircleIcon />}>
          No se han identificado condiciones de vulnerabilidad ni vulneraciones para esta persona.
        </Alert>
      </Box>
    )
  }

  return (
    <Box>
      {/* Condiciones de Vulnerabilidad Section */}
      <Box sx={{ mb: 4 }}>
        <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 3 }}>
          <WarningIcon color="warning" />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Condiciones de Vulnerabilidad
          </Typography>
          {condiciones.length > 0 && (
            <Chip
              label={`${condiciones.length} ${condiciones.length === 1 ? "condición" : "condiciones"}`}
              size="small"
              color="warning"
              variant="outlined"
            />
          )}
        </Box>

        {condiciones.length > 0 ? (
          <>
            {/* Summary Alert */}
            <Alert severity="warning" icon={<WarningIcon />} sx={{ mb: 2 }}>
              Se han identificado <strong>{condiciones.length}</strong> condiciones de vulnerabilidad.
            </Alert>

            {/* Conditions List */}
            <List disablePadding>
              {condiciones.map((condicion) => (
                <CondicionCard key={condicion.id} condicion={condicion} />
              ))}
            </List>

          </>
        ) : (
          <Alert severity="success" icon={<CheckCircleIcon />}>
            No se han identificado condiciones de vulnerabilidad.
          </Alert>
        )}
      </Box>

      <Divider sx={{ my: 3 }} />

      {/* Vulneraciones Section */}
      <Box>
        <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 3 }}>
          <GavelIcon color="error" />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Presuntas Vulneraciones de Derechos
          </Typography>
          {vulneraciones.length > 0 && (
            <Chip
              label={`${vulneraciones.length} ${vulneraciones.length === 1 ? "vulneración" : "vulneraciones"}`}
              size="small"
              color="error"
              variant="outlined"
            />
          )}
        </Box>

        {vulneraciones.length > 0 ? (
          <>
            {/* Summary Alert */}
            <Alert
              severity="error"
              icon={<GavelIcon />}
              sx={{ mb: 2 }}
            >
              Se han registrado <strong>{vulneraciones.length}</strong> presuntas vulneraciones
              de derechos
              {vulneraciones.filter((v) => v.transcurre_actualidad).length > 0 && (
                <>, de las cuales <strong>{vulneraciones.filter((v) => v.transcurre_actualidad).length}</strong> están actualmente en curso</>
              )}
              .
            </Alert>

            {/* Vulneraciones Cards */}
            {vulneraciones.map((vulneracion) => (
              <VulneracionCard key={vulneracion.id} vulneracion={vulneracion} />
            ))}

          </>
        ) : (
          <Alert severity="success" icon={<CheckCircleIcon />}>
            No se han registrado presuntas vulneraciones de derechos.
          </Alert>
        )}
      </Box>
    </Box>
  )
}

export default VulnerabilityDisplay
